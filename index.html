<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diabetes Guardian</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    body{font-family:system-ui,Arial; background:#0b1220; color:#e6edf3; margin:0; padding:16px;}
    h1{margin:6px 0 2px}
    .sub{opacity:.8; font-size:12px; margin-bottom:12px}
    .card{background:#111a2e; border:1px solid #223; border-radius:14px; padding:12px; margin:10px 0;}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    label{font-size:12px; opacity:.85}
    input,select,textarea{width:100%; padding:10px; border-radius:12px; border:1px solid #334; background:#0f1730; color:#fff; margin-top:6px}
    button{padding:10px 12px; border-radius:12px; border:1px solid #334; background:#1a2a4a; color:#fff; margin:6px 6px 0 0}
    .ok{border-color:#2f6}
    .warn{border-color:#fa4}
    .danger{border-color:#f44}
    .small{opacity:.8; font-size:12px; line-height:1.4}
    .en{direction:ltr; text-align:left; opacity:.85; font-size:12px; margin-top:6px}
  </style>
</head>
<body>
  <h1>ğŸ›¡ï¸ Diabetes Guardian</h1>
  <div class="sub">Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø£Ø³Ø§Ø³ÙŠ + English backup â€¢ ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ£Ù…Ø§Ù† â€¢ (Ø¨Ø¯ÙˆÙ† Ø¬Ø±Ø¹Ø§Øª Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†)</div>

  <div class="card" id="statusCard">
    <b>Ø§Ù„Ø­Ø§Ù„Ø©</b>
    <div id="statusAr" class="small">Ø¬Ø§Ù‡Ø².</div>
    <div id="statusEn" class="en">Ready.</div>
  </div>

  <div class="card">
    <b>Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹</b>

    <div class="row">
      <div>
        <label>Ø³ÙƒØ± Ø§Ù„Ø¢Ù† (mg/dL)</label>
        <input id="glucose" type="number" placeholder="Ù…Ø«Ø§Ù„: 92" />
      </div>
      <div>
        <label>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label>
        <select id="trend">
          <option value="steady">Ø«Ø§Ø¨Øª</option>
          <option value="falling">Ù†Ø§Ø²Ù„</option>
          <option value="fast_falling">Ù†Ø§Ø²Ù„ Ø¨Ø³Ø±Ø¹Ø©</option>
          <option value="rising">Ø·Ø§Ù„Ø¹</option>
        </select>
      </div>
    </div>

    <div class="row">
      <button onclick="setMode('normal')">ğŸ  ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ</button>
      <button onclick="setMode('work')">ğŸ§‘â€ğŸ’¼ ÙˆØ¶Ø¹ Ø´ØºÙ„</button>
      <button onclick="toggleFlag('coffee')">â˜• Ù‚Ù‡ÙˆØ©</button>
      <button onclick="toggleFlag('smoking')">ğŸš¬ ØªØ¯Ø®ÙŠÙ†</button>
    </div>

    <div class="row">
      <button onclick="logEvent('meal')">ğŸ½ï¸ Ø³Ø¬Ù„ ÙˆØ¬Ø¨Ø©</button>
      <button onclick="logEvent('bolus')">ğŸ’‰ Ø³Ø¬Ù„ Ù†ÙˆÙÙˆØ±Ø§Ø¨ÙŠØ¯</button>
      <button onclick="runSafetyCheck()">ğŸ” ÙØ­Øµ Ø£Ù…Ø§Ù†</button>
      <button onclick="panic()">ğŸš¨ Ø·ÙˆØ§Ø±Ø¦</button>
    </div>

    <div id="ctx" class="small" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <b>Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©</b>
    <div class="small">
      Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡Ø¯ÙÙ‡ <b>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ù„Ø£Ù…Ø§Ù†</b> ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«. Ù„Ø§ ÙŠØ¹Ø·ÙŠ Ø¬Ø±Ø¹Ø§Øª Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†.
      Ø¥Ø°Ø§ ÙÙŠ Ù‡Ø¨ÙˆØ· Ø´Ø¯ÙŠØ¯/ØªØ´Ù†Ø¬/Ø¹Ø¯Ù… Ø§Ø³ØªØ¬Ø§Ø¨Ø©: Ø§Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§ ÙˆØ§ØªØ¨Ø¹ Ø®Ø·Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦/Ø§Ù„ØºÙ„ÙˆÙƒØ§ØºÙˆÙ† Ø­Ø³Ø¨ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø·Ø¨ÙŠØ¨Ùƒ.
    </div>
    <div class="en">
      Safety tool only. No insulin dosing. For severe hypo/unresponsiveness: seek help immediately and follow your emergency plan/glucagon instructions.
    </div>
  </div>

<script>
  // ---- State ----
  const state = {
    mode: "normal",
    coffee: false,
    smoking: false,
    lastMealISO: null,
    lastBolusISO: null
  };

  // ---- Helpers ----
  const $ = (id)=>document.getElementById(id);
  const nowISO = ()=> new Date().toISOString();
  const minsSince = (iso)=> iso ? Math.floor((Date.now()-new Date(iso).getTime())/60000) : null;

  function renderCtx(){
    const meal = minsSince(state.lastMealISO);
    const bolus = minsSince(state.lastBolusISO);
    $("ctx").innerText =
      `mode=${state.mode} | coffee=${state.coffee} | smoking=${state.smoking} | ` +
      `last_meal=${meal===null?"â€”":meal+"m"} | last_bolus=${bolus===null?"â€”":bolus+"m"}`;
  }

  function setStatus(ar, en, level="ok", speakIt=false){
    const card = $("statusCard");
    card.className = "card " + level;
    $("statusAr").innerText = ar;
    $("statusEn").innerText = en;

    if(speakIt){
      speak(ar); // Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‡Ùˆ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„ØµÙˆØª
    }
  }

  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ar";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }

  // ---- Actions ----
  function setMode(mode){
    state.mode = mode;
    renderCtx();
    setStatus(
      mode==="work" ? "ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´ØºÙ„." : "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ.",
      mode==="work" ? "Work mode enabled." : "Normal mode enabled.",
      "ok",
      true
    );
  }

  function toggleFlag(which){
    if(which==="coffee") state.coffee = !state.coffee;
    if(which==="smoking") state.smoking = !state.smoking;
    renderCtx();
    setStatus(
      "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.",
      "Status updated.",
      "ok",
      false
    );
  }

  function logEvent(type){
    if(type==="meal") state.lastMealISO = nowISO();
    if(type==="bolus") state.lastBolusISO = nowISO();
    renderCtx();
    setStatus(
      type==="meal" ? "ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙˆØ¬Ø¨Ø©." : "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ÙˆÙÙˆØ±Ø§Ø¨ÙŠØ¯.",
      type==="meal" ? "Meal logged." : "Bolus logged.",
      "ok",
      false
    );
  }

  // ---- Safety rules (simple, for Phase A) ----
  // You can change thresholds later from guardian_rules.json when we wire it in the next step.
  const TH = {
    hypoUrgent: 55,
    hypoRisk: 70
  };

  function runSafetyCheck(){
    const g = Number($("glucose").value || 0);
    const trend = $("trend").value;

    if(!g || g<=0){
      setStatus("Ø§ÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙƒØ± Ø£ÙˆÙ„Ù‹Ø§.", "Enter glucose value first.", "warn", true);
      return;
    }

    // Ø­Ø³Ø§Ø³ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ùˆ Ø´ØºÙ„/Ù‚Ù‡ÙˆØ©/ØªØ¯Ø®ÙŠÙ†
    const sensitive = (state.mode==="work" || state.coffee || state.smoking);

    // Ø®Ø·Ø± Ø´Ø¯ÙŠØ¯
    if(g <= TH.hypoUrgent){
      setStatus(
        "ğŸš¨ Ù‡Ø¨ÙˆØ· Ø®Ø·ÙŠØ±. Ø®Ø° ÙƒØ§Ø±Ø¨ Ø³Ø±ÙŠØ¹ ÙÙˆØ±Ù‹Ø§ ÙˆØ§Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø°Ø§ Ø£Ù†Øª ÙˆØ­Ø¯Ùƒ.",
        "ğŸš¨ Severe low. Take fast carbs now and get help if alone.",
        "danger",
        true
      );
      return;
    }

    // Ù‡Ø¨ÙˆØ· + Ù†Ø§Ø²Ù„
    const falling = (trend==="falling" || trend==="fast_falling");
    if(g <= TH.hypoRisk && falling){
      setStatus(
        sensitive
          ? "âš ï¸ Ù‡Ø¨ÙˆØ· ÙˆÙ†Ø²ÙˆÙ„. Ø¨Ù…Ø§ Ø£Ù†Ùƒ Ø¨Ø­Ø±ÙƒØ©/Ù‚Ù‡ÙˆØ©/ØªØ¯Ø®ÙŠÙ†: Ø®Ø° ÙƒØ§Ø±Ø¨ Ø³Ø±ÙŠØ¹ Ø§Ù„Ø¢Ù†."
          : "âš ï¸ Ù‡Ø¨ÙˆØ· ÙˆÙ†Ø²ÙˆÙ„. Ø®Ø° ÙƒØ§Ø±Ø¨ Ø³Ø±ÙŠØ¹ ÙˆØ±Ø§Ù‚Ø¨.",
        "âš ï¸ Low + falling. Take fast carbs and monitor.",
        "warn",
        true
      );
      return;
    }

    // Ù‚ÙÙ„ Ø§Ù„Ù†ÙˆÙ…: ÙˆØ¬Ø¨Ø© Ø£Ùˆ Ù†ÙˆÙÙˆØ±Ø§Ø¨ÙŠØ¯ Ù‚Ø±ÙŠØ¨
    const mMeal = minsSince(state.lastMealISO);
    const mBolus = minsSince(state.lastBolusISO);
    const mealLock = (mMeal!==null && mMeal<=120);
    const bolusLock = (mBolus!==null && mBolus<=180);

    if(mealLock || bolusLock){
      setStatus(
        "ğŸ›‘ Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…: ÙÙŠ ÙˆØ¬Ø¨Ø©/Ù†ÙˆÙÙˆØ±Ø§Ø¨ÙŠØ¯ Ù‚Ø±ÙŠØ¨. Ù„Ø§ ØªÙ†Ø§Ù… Ø¨Ø¯ÙˆÙ† Ù…ØªØ§Ø¨Ø¹Ø©.",
        "ğŸ›‘ Pre-sleep caution: recent meal/bolus. Monitor before sleep.",
        "warn",
        true
      );
      return;
    }

    setStatus(
      "âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø¢Ù…Ù† Ø­Ø§Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª.",
      "âœ… Looks safe for now based on inputs.",
      "ok",
      false
    );
  }

  function panic(){
    setStatus(
      "ğŸš¨ Ø·ÙˆØ§Ø±Ø¦! Ø§Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§.",
      "ğŸš¨ Emergency! Get help now.",
      "danger",
      true
    );
    // Ù†ÙƒØ±Ø± Ø§Ù„ØµÙˆØª ÙƒØªÙ†Ø¨ÙŠÙ‡ Ø£Ù‚ÙˆÙ‰
    setTimeout(()=>speak("Ø·ÙˆØ§Ø±Ø¦. Ø§Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§."), 900);
    setTimeout(()=>speak("Ø·ÙˆØ§Ø±Ø¦. Ø§Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§."), 1800);
  }

  // Boot
  renderCtx();
  setStatus("Ø¬Ø§Ù‡Ø². Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³ÙƒØ± ÙˆØ§Ø¶ØºØ· ÙØ­Øµ Ø£Ù…Ø§Ù†.", "Ready. Enter glucose then run Safety Check.", "ok", false);
</script>
</body>
</html>
